name: CI

on: [push, pull_request]

jobs:
  job1:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install dependencies
        run: npm install

      - name: Run project
        run: npm start
      - name: Wait for the app to start
        run: |
          timeout=0
          while ! curl --silent --head http://localhost:4200; do
            if [ $timeout -gt 30 ]; then
              echo "App failed to start after 30 seconds."
              exit 1
            fi
            echo "Waiting for app to start..."
            sleep 5
            timeout=$((timeout + 5))
          done
          echo "App is up and running!"

      - name: Run tests
        run: npm run test:e2e

      - name: Generate Allure Report
        run: npx allure generate allure-results --clean -o allure-report

      - name: Upload report to Allure TestOps
        env:
          ALLURE_TOKEN: ${{ secrets.ALLURE_TOKEN }}
          ALLURE_ENDPOINT: "https://hardy.testops.cloud/"
          ALLURE_PROJECT_ID: "#1"
        run: allurectl upload --results allure-results